
/**
 * Test dependencies.
 */

var mpath = require('../')
var assert = require('assert')

/**
 * logging helper
 */

function log (o) {
  console.log();
  console.log(require('util').inspect(o, false, 1000));
***REMOVED***

/**
 * special path for override tests
 */

var special = '_doc';

/**
 * Tests
 */

describe('mpath', function(){

  /**
   * test doc creator
   */

  function doc () {
    var o = { first: { second: { third: [3,{ name: 'aaron' ***REMOVED***, 9] ***REMOVED******REMOVED******REMOVED***;
    o.comments = [
        { name: 'one' ***REMOVED***
      , { name: 'two', _doc: { name: '2' ***REMOVED******REMOVED***
      , { name: 'three'
          , comments: [{***REMOVED***,{ comments: [{val: 'twoo'***REMOVED***]***REMOVED***]
          , _doc: { name: '3', comments: [{***REMOVED***,{ _doc: { comments: [{ val: 2 ***REMOVED***] ***REMOVED******REMOVED***]  ***REMOVED******REMOVED***
    ];
    o.name = 'jiro';
    o.array = [
        { o: { array: [{x: {b: [4,6,8]***REMOVED******REMOVED***, { y: 10***REMOVED*** ] ***REMOVED******REMOVED***
      , { o: { array: [{x: {b: [1,2,3]***REMOVED******REMOVED***, { x: {z: 10 ***REMOVED******REMOVED***, { x: {b: 'hi'***REMOVED******REMOVED***] ***REMOVED******REMOVED***
      , { o: { array: [{x: {b: null ***REMOVED******REMOVED***, { x: { b: [null, 1]***REMOVED******REMOVED***] ***REMOVED******REMOVED***
      , { o: { array: [{x: null ***REMOVED***] ***REMOVED******REMOVED***
      , { o: { array: [{y: 3 ***REMOVED***] ***REMOVED******REMOVED***
      , { o: { array: [3, 0, null] ***REMOVED******REMOVED***
      , { o: { name: 'ha' ***REMOVED******REMOVED***
    ];
    o.arr = [
        { arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
      , { yep: true ***REMOVED***
    ]
    return o;
  ***REMOVED***

  describe('get', function(){
    var o = doc();

    it('`path` must be a string or array', function(done){
      assert.throws(function () {
        mpath.get({***REMOVED***, o);
      ***REMOVED***, /Must be either string or array/);
      assert.throws(function () {
        mpath.get(4, o);
      ***REMOVED***, /Must be either string or array/);
      assert.throws(function () {
        mpath.get(function(){***REMOVED***, o);
      ***REMOVED***, /Must be either string or array/);
      assert.throws(function () {
        mpath.get(/asdf/, o);
      ***REMOVED***, /Must be either string or array/);
      assert.throws(function () {
        mpath.get(Math, o);
      ***REMOVED***, /Must be either string or array/);
      assert.throws(function () {
        mpath.get(Buffer, o);
      ***REMOVED***, /Must be either string or array/);
      assert.doesNotThrow(function () {
        mpath.get('string', o);
      ***REMOVED***);
      assert.doesNotThrow(function () {
        mpath.get([], o);
      ***REMOVED***);
      done();
    ***REMOVED***)

    describe('without `special`', function(){
      it('works', function(done){
        assert.equal('jiro', mpath.get('name', o));

        assert.deepEqual(
          { second: { third: [3,{ name: 'aaron' ***REMOVED***, 9] ***REMOVED******REMOVED***
          , mpath.get('first', o)
        );

        assert.deepEqual(
          { third: [3,{ name: 'aaron' ***REMOVED***, 9] ***REMOVED***
          , mpath.get('first.second', o)
        );

        assert.deepEqual(
          [3,{ name: 'aaron' ***REMOVED***, 9]
          , mpath.get('first.second.third', o)
        );

        assert.deepEqual(
          3
          , mpath.get('first.second.third.0', o)
        );

        assert.deepEqual(
          9
          , mpath.get('first.second.third.2', o)
        );

        assert.deepEqual(
          { name: 'aaron' ***REMOVED***
          , mpath.get('first.second.third.1', o)
        );

        assert.deepEqual(
          'aaron'
          , mpath.get('first.second.third.1.name', o)
        );

        assert.deepEqual([
            { name: 'one' ***REMOVED***
          , { name: 'two', _doc: { name: '2' ***REMOVED******REMOVED***
          , { name: 'three'
            , comments: [{***REMOVED***,{ comments: [{val: 'twoo'***REMOVED***]***REMOVED***]
            , _doc: { name: '3', comments: [{***REMOVED***,{ _doc: { comments: [{ val: 2 ***REMOVED***] ***REMOVED******REMOVED***]***REMOVED******REMOVED***],
          mpath.get('comments', o));

        assert.deepEqual({ name: 'one' ***REMOVED***, mpath.get('comments.0', o));
        assert.deepEqual('one', mpath.get('comments.0.name', o));
        assert.deepEqual('two', mpath.get('comments.1.name', o));
        assert.deepEqual('three', mpath.get('comments.2.name', o));

        assert.deepEqual([{***REMOVED***,{ comments: [{val: 'twoo'***REMOVED***]***REMOVED***]
            , mpath.get('comments.2.comments', o));

        assert.deepEqual({ comments: [{val: 'twoo'***REMOVED***]***REMOVED***
            , mpath.get('comments.2.comments.1', o));

        assert.deepEqual('twoo', mpath.get('comments.2.comments.1.comments.0.val', o));

        done();
      ***REMOVED***)

      it('handles array.property dot-notation', function(done){
        assert.deepEqual(
            ['one', 'two', 'three']
          , mpath.get('comments.name', o)
        );
        done();
      ***REMOVED***)

      it('handles array.array notation', function(done){
        assert.deepEqual(
            [undefined, undefined, [{***REMOVED***, {comments:[{val:'twoo'***REMOVED***]***REMOVED***]]
          , mpath.get('comments.comments', o)
        );
        done();
      ***REMOVED***)

      it('handles prop.prop.prop.arrayProperty notation', function(done){
        assert.deepEqual(
          [undefined, 'aaron', undefined]
          , mpath.get('first.second.third.name', o)
        );
        assert.deepEqual(
          [1, 'aaron', 1]
          , mpath.get('first.second.third.name', o, function (v) {
            return undefined === v ? 1 : v;
          ***REMOVED***)
        );
        done();
      ***REMOVED***)

      it('handles array.prop.array', function(done){
        assert.deepEqual(
            [ [{x: {b: [4,6,8]***REMOVED******REMOVED***, { y: 10***REMOVED*** ]
            , [{x: {b: [1,2,3]***REMOVED******REMOVED***, { x: {z: 10 ***REMOVED******REMOVED***, { x: {b: 'hi'***REMOVED******REMOVED***]
            , [{x: {b: null ***REMOVED******REMOVED***, { x: { b: [null, 1]***REMOVED******REMOVED***]
            , [{x: null ***REMOVED***]
            , [{y: 3 ***REMOVED***]
            , [3, 0, null]
            , undefined
            ]
          , mpath.get('array.o.array', o)
        );
        done();
      ***REMOVED***)

      it('handles array.prop.array.index', function(done){
        assert.deepEqual(
            [ {x: {b: [4,6,8]***REMOVED******REMOVED***
            , {x: {b: [1,2,3]***REMOVED******REMOVED***
            , {x: {b: null ***REMOVED******REMOVED***
            , {x: null ***REMOVED***
            , {y: 3 ***REMOVED***
            , 3
            , undefined
            ]
          , mpath.get('array.o.array.0', o)
        );
        done();
      ***REMOVED***)

      it('handles array.prop.array.index.prop', function(done){
        assert.deepEqual(
            [ {b: [4,6,8]***REMOVED***
            , {b: [1,2,3]***REMOVED***
            , {b: null ***REMOVED***
            , null
            , undefined
            , undefined
            , undefined
            ]
          , mpath.get('array.o.array.0.x', o)
        );
        done();
      ***REMOVED***)

      it('handles array.prop.array.prop', function(done){
        assert.deepEqual(
            [ [undefined, 10 ]
            , [undefined, undefined, undefined]
            , [undefined, undefined]
            , [undefined]
            , [3]
            , [undefined, undefined, undefined]
            , undefined
            ]
          , mpath.get('array.o.array.y', o)
        );
        assert.deepEqual(
            [ [{b: [4,6,8]***REMOVED***, undefined]
            , [{b: [1,2,3]***REMOVED***,  {z: 10 ***REMOVED***, {b: 'hi'***REMOVED***]
            , [{b: null ***REMOVED***, { b: [null, 1]***REMOVED***]
            , [null]
            , [undefined]
            , [undefined, undefined, undefined]
            , undefined
            ]
          , mpath.get('array.o.array.x', o)
        );
        done();
      ***REMOVED***)

      it('handles array.prop.array.prop.prop', function(done){
        assert.deepEqual(
            [ [[4,6,8], undefined]
            , [[1,2,3], undefined, 'hi']
            , [null, [null, 1]]
            , [null]
            , [undefined]
            , [undefined, undefined, undefined]
            , undefined
            ]
          , mpath.get('array.o.array.x.b', o)
        );
        done();
      ***REMOVED***)

      it('handles array.prop.array.prop.prop.index', function(done){
        assert.deepEqual(
            [ [6, undefined]
            , [2, undefined, 'i'] // undocumented feature (string indexing)
            , [null, 1]
            , [null]
            , [undefined]
            , [undefined, undefined, undefined]
            , undefined
            ]
          , mpath.get('array.o.array.x.b.1', o)
        );
        assert.deepEqual(
            [ [6, 0]
            , [2, 0, 'i'] // undocumented feature (string indexing)
            , [null, 1]
            , [null]
            , [0]
            , [0, 0, 0]
            , 0
            ]
          , mpath.get('array.o.array.x.b.1', o, function (v) {
            return undefined === v ? 0 : v;
          ***REMOVED***)
        );
        done();
      ***REMOVED***)

      it('handles array.index.prop.prop', function(done){
        assert.deepEqual(
            [{x: {b: [1,2,3]***REMOVED******REMOVED***, { x: {z: 10 ***REMOVED******REMOVED***, { x: {b: 'hi'***REMOVED******REMOVED***]
          , mpath.get('array.1.o.array', o)
        );
        assert.deepEqual(
            ['hi','hi','hi']
          , mpath.get('array.1.o.array', o, function (v) {
            if (Array.isArray(v)) {
              return v.map(function (val) {
                return 'hi';
              ***REMOVED***)
            ***REMOVED***
            return v;
          ***REMOVED***)
        );
        done();
      ***REMOVED***)

      it('handles array.array.index', function(done){
        assert.deepEqual(
            [{ a: { c: 48 ***REMOVED******REMOVED***, undefined]
          , mpath.get('arr.arr.1', o)
        );
        assert.deepEqual(
            ['woot', undefined]
          , mpath.get('arr.arr.1', o, function (v) {
            if (v && v.a && v.a.c) return 'woot';
            return v;
          ***REMOVED***)
        );
        done();
      ***REMOVED***)

      it('handles array.array.index.prop', function(done){
        assert.deepEqual(
            [{ c: 48 ***REMOVED***, 'woot']
          , mpath.get('arr.arr.1.a', o, function (v) {
            if (undefined === v) return 'woot';
            return v;
          ***REMOVED***)
        );
        assert.deepEqual(
            [{ c: 48 ***REMOVED***, undefined]
          , mpath.get('arr.arr.1.a', o)
        );
        mpath.set('arr.arr.1.a', [{c:49***REMOVED***,undefined], o)
        assert.deepEqual(
            [{ c: 49 ***REMOVED***, undefined]
          , mpath.get('arr.arr.1.a', o)
        );
        mpath.set('arr.arr.1.a', [{c:48***REMOVED***,undefined], o)
        done();
      ***REMOVED***)

      it('handles array.array.index.prop.prop', function(done){
        assert.deepEqual(
            [48, undefined]
          , mpath.get('arr.arr.1.a.c', o)
        );
        assert.deepEqual(
            [48, 'woot']
          , mpath.get('arr.arr.1.a.c', o, function (v) {
            if (undefined === v) return 'woot';
            return v;
          ***REMOVED***)
        );
        done();
      ***REMOVED***)

    ***REMOVED***)

    describe('with `special`', function(){
      describe('that is a string', function(){
        it('works', function(done){
          assert.equal('jiro', mpath.get('name', o, special));

          assert.deepEqual(
            { second: { third: [3,{ name: 'aaron' ***REMOVED***, 9] ***REMOVED******REMOVED***
            , mpath.get('first', o, special)
          );

          assert.deepEqual(
            { third: [3,{ name: 'aaron' ***REMOVED***, 9] ***REMOVED***
            , mpath.get('first.second', o, special)
          );

          assert.deepEqual(
            [3,{ name: 'aaron' ***REMOVED***, 9]
            , mpath.get('first.second.third', o, special)
          );

          assert.deepEqual(
            3
            , mpath.get('first.second.third.0', o, special)
          );

          assert.deepEqual(
            4
            , mpath.get('first.second.third.0', o, special, function (v) {
              return 3 === v ? 4 : v;
            ***REMOVED***)
          );

          assert.deepEqual(
            9
            , mpath.get('first.second.third.2', o, special)
          );

          assert.deepEqual(
            { name: 'aaron' ***REMOVED***
            , mpath.get('first.second.third.1', o, special)
          );

          assert.deepEqual(
            'aaron'
            , mpath.get('first.second.third.1.name', o, special)
          );

          assert.deepEqual([
              { name: 'one' ***REMOVED***
            , { name: 'two', _doc: { name: '2' ***REMOVED******REMOVED***
            , { name: 'three'
              , comments: [{***REMOVED***,{ comments: [{val: 'twoo'***REMOVED***]***REMOVED***]
              , _doc: { name: '3', comments: [{***REMOVED***,{ _doc: { comments: [{ val: 2 ***REMOVED***] ***REMOVED******REMOVED***]***REMOVED******REMOVED***],
            mpath.get('comments', o, special));

          assert.deepEqual({ name: 'one' ***REMOVED***, mpath.get('comments.0', o, special));
          assert.deepEqual('one', mpath.get('comments.0.name', o, special));
          assert.deepEqual('2', mpath.get('comments.1.name', o, special));
          assert.deepEqual('3', mpath.get('comments.2.name', o, special));
          assert.deepEqual('nice', mpath.get('comments.2.name', o, special, function (v) {
            return '3' === v ? 'nice' : v;
          ***REMOVED***));

          assert.deepEqual([{***REMOVED***,{ _doc: { comments: [{ val: 2 ***REMOVED***] ***REMOVED******REMOVED***]
              , mpath.get('comments.2.comments', o, special));

          assert.deepEqual({ _doc: { comments: [{val: 2***REMOVED***]***REMOVED******REMOVED***
              , mpath.get('comments.2.comments.1', o, special));

          assert.deepEqual(2, mpath.get('comments.2.comments.1.comments.0.val', o, special));
          done();
        ***REMOVED***)

        it('handles array.property dot-notation', function(done){
          assert.deepEqual(
            ['one', '2', '3']
            , mpath.get('comments.name', o, special)
          );
          assert.deepEqual(
            ['one', 2, '3']
            , mpath.get('comments.name', o, special, function (v) {
              return '2' === v ? 2 : v
            ***REMOVED***)
          );
          done();
        ***REMOVED***)

        it('handles array.array notation', function(done){
          assert.deepEqual(
              [undefined, undefined, [{***REMOVED***, {_doc: { comments:[{val:2***REMOVED***]***REMOVED******REMOVED***]]
            , mpath.get('comments.comments', o, special)
          );
          done();
        ***REMOVED***)

        it('handles array.array.index.array', function(done){
          assert.deepEqual(
              [undefined, undefined, [{val:2***REMOVED***]]
            , mpath.get('comments.comments.1.comments', o, special)
          );
          done();
        ***REMOVED***)

        it('handles array.array.index.array.prop', function(done){
          assert.deepEqual(
              [undefined, undefined, [2]]
            , mpath.get('comments.comments.1.comments.val', o, special)
          );
          assert.deepEqual(
              ['nil', 'nil', [2]]
            , mpath.get('comments.comments.1.comments.val', o, special, function (v) {
              return undefined === v ? 'nil' : v;
            ***REMOVED***)
          );
          done();
        ***REMOVED***)
      ***REMOVED***)

      describe('that is a function', function(){
        var special = function (obj, key) {
          return obj[key]
        ***REMOVED***

        it('works', function(done){
          assert.equal('jiro', mpath.get('name', o, special));

          assert.deepEqual(
            { second: { third: [3,{ name: 'aaron' ***REMOVED***, 9] ***REMOVED******REMOVED***
            , mpath.get('first', o, special)
          );

          assert.deepEqual(
            { third: [3,{ name: 'aaron' ***REMOVED***, 9] ***REMOVED***
            , mpath.get('first.second', o, special)
          );

          assert.deepEqual(
            [3,{ name: 'aaron' ***REMOVED***, 9]
            , mpath.get('first.second.third', o, special)
          );

          assert.deepEqual(
            3
            , mpath.get('first.second.third.0', o, special)
          );

          assert.deepEqual(
            4
            , mpath.get('first.second.third.0', o, special, function (v) {
              return 3 === v ? 4 : v;
            ***REMOVED***)
          );

          assert.deepEqual(
            9
            , mpath.get('first.second.third.2', o, special)
          );

          assert.deepEqual(
            { name: 'aaron' ***REMOVED***
            , mpath.get('first.second.third.1', o, special)
          );

          assert.deepEqual(
            'aaron'
            , mpath.get('first.second.third.1.name', o, special)
          );

          assert.deepEqual([
              { name: 'one' ***REMOVED***
            , { name: 'two', _doc: { name: '2' ***REMOVED******REMOVED***
            , { name: 'three'
              , comments: [{***REMOVED***,{ comments: [{val: 'twoo'***REMOVED***]***REMOVED***]
              , _doc: { name: '3', comments: [{***REMOVED***,{ _doc: { comments: [{ val: 2 ***REMOVED***] ***REMOVED******REMOVED***]***REMOVED******REMOVED***],
            mpath.get('comments', o, special));

          assert.deepEqual({ name: 'one' ***REMOVED***, mpath.get('comments.0', o, special));
          assert.deepEqual('one', mpath.get('comments.0.name', o, special));
          assert.deepEqual('two', mpath.get('comments.1.name', o, special));
          assert.deepEqual('three', mpath.get('comments.2.name', o, special));
          assert.deepEqual('nice', mpath.get('comments.2.name', o, special, function (v) {
            return 'three' === v ? 'nice' : v;
          ***REMOVED***));

          assert.deepEqual([{***REMOVED***,{ comments: [{ val: 'twoo' ***REMOVED***] ***REMOVED***]
              , mpath.get('comments.2.comments', o, special));

          assert.deepEqual({ comments: [{val: 'twoo'***REMOVED***]***REMOVED***
              , mpath.get('comments.2.comments.1', o, special));

          assert.deepEqual('twoo', mpath.get('comments.2.comments.1.comments.0.val', o, special));

          var overide = false;
          assert.deepEqual('twoo', mpath.get('comments.8.comments.1.comments.0.val', o, function (obj, path) {
            if (Array.isArray(obj) && 8 == path) {
              overide = true;
              return obj[2];
            ***REMOVED***
            return obj[path];
          ***REMOVED***));
          assert.ok(overide);

          done();
        ***REMOVED***)

        it('in combination with map', function(done){
          var special = function (obj, key) {
            if (Array.isArray(obj)) return obj[key];
            return obj.mpath;
          ***REMOVED***
          var map = function (val) {
            return 'convert' == val
              ? 'mpath'
              : val;
          ***REMOVED***
          var o = { mpath: [{ mpath: 'converse' ***REMOVED***, { mpath: 'convert' ***REMOVED***] ***REMOVED***

          assert.equal('mpath', mpath.get('something.1.kewl', o, special, map));
          done();
        ***REMOVED***)
      ***REMOVED***)
    ***REMOVED***)
  ***REMOVED***)

  describe('set', function() {
    it('prevents writing to __proto__', function() {
      var obj = {***REMOVED***;
      mpath.set('__proto__.x', 'foobar', obj);
      assert.ok(!({***REMOVED***.x));

      mpath.set('constructor.prototype.x', 'foobar', obj);
      assert.ok(!({***REMOVED***.x));
    ***REMOVED***);

    describe('without `special`', function() {
      var o = doc();

      it('works', function(done) {
        mpath.set('name', 'a new val', o, function(v) {
          return 'a new val' === v ? 'changed' : v;
        ***REMOVED***);
        assert.deepEqual('changed', o.name);

        mpath.set('name', 'changed', o);
        assert.deepEqual('changed', o.name);

        mpath.set('first.second.third', [1,{name:'x'***REMOVED***,9], o);
        assert.deepEqual([1,{name:'x'***REMOVED***,9], o.first.second.third);

        mpath.set('first.second.third.1.name', 'y', o)
        assert.deepEqual([1,{name:'y'***REMOVED***,9], o.first.second.third);

        mpath.set('comments.1.name', 'ttwwoo', o);
        assert.deepEqual({ name: 'ttwwoo', _doc: { name: '2' ***REMOVED******REMOVED***, o.comments[1]);

        mpath.set('comments.2.comments.1.comments.0.expand', 'added', o);
        assert.deepEqual(
            { val: 'twoo', expand: 'added'***REMOVED***
          , o.comments[2].comments[1].comments[0]);

        mpath.set('comments.2.comments.1.comments.2', 'added', o);
        assert.equal(3, o.comments[2].comments[1].comments.length);
        assert.deepEqual(
            { val: 'twoo', expand: 'added'***REMOVED***
          , o.comments[2].comments[1].comments[0]);
        assert.deepEqual(
            undefined
          , o.comments[2].comments[1].comments[1]);
        assert.deepEqual(
            'added'
          , o.comments[2].comments[1].comments[2]);

        done();
      ***REMOVED***)

      describe('array.path', function(){
        describe('with single non-array value', function(){
          it('works', function(done){
            mpath.set('arr.yep', false, o, function (v) {
              return false === v ? true: v;
            ***REMOVED***);
            assert.deepEqual([
              { yep: true, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: true ***REMOVED***
            ], o.arr);

            mpath.set('arr.yep', false, o);

            assert.deepEqual([
              { yep: false, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: false ***REMOVED***
            ], o.arr);

            done();
          ***REMOVED***)
        ***REMOVED***)
        describe('with array of values', function(){
          it('that are equal in length', function(done){
            mpath.set('arr.yep', ['one',2], o, function (v) {
              return 'one' === v ? 1 : v;
            ***REMOVED***);
            assert.deepEqual([
              { yep: 1, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: 2 ***REMOVED***
            ], o.arr);
            mpath.set('arr.yep', ['one',2], o);

            assert.deepEqual([
              { yep: 'one', arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: 2 ***REMOVED***
            ], o.arr);

            done();
          ***REMOVED***)

          it('that is less than length', function(done){
            mpath.set('arr.yep', [47], o, function (v) {
              return 47 === v ? 4 : v;
            ***REMOVED***);
            assert.deepEqual([
              { yep: 4, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: 2 ***REMOVED***
            ], o.arr);

            mpath.set('arr.yep', [47], o);
            assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: 2 ***REMOVED***
            ], o.arr);

            done();
          ***REMOVED***)

          it('that is greater than length', function(done){
            mpath.set('arr.yep', [5,6,7], o, function (v) {
              return 5 === v ? 'five' : v;
            ***REMOVED***);
            assert.deepEqual([
              { yep: 'five', arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: 6 ***REMOVED***
            ], o.arr);

            mpath.set('arr.yep', [5,6,7], o);
            assert.deepEqual([
              { yep: 5, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: 6 ***REMOVED***
            ], o.arr);

            done();
          ***REMOVED***)
        ***REMOVED***)
      ***REMOVED***)

      describe('array.$.path', function(){
        describe('with single non-array value', function(){
          it('copies the value to each item in array', function(done){
            mpath.set('arr.$.yep', {xtra: 'double good'***REMOVED***, o, function (v) {
              return v && v.xtra ? 'hi' : v;
            ***REMOVED***);
            assert.deepEqual([
              { yep: 'hi', arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: 'hi'***REMOVED***
            ], o.arr);

            mpath.set('arr.$.yep', {xtra: 'double good'***REMOVED***, o);
            assert.deepEqual([
              { yep: {xtra:'double good'***REMOVED***, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: {xtra:'double good'***REMOVED******REMOVED***
            ], o.arr);

            done();
          ***REMOVED***)
        ***REMOVED***)
        describe('with array of values', function(){
          it('copies the value to each item in array', function(done){
            mpath.set('arr.$.yep', [15], o, function (v) {
              return v.length === 1 ? [] : v;
            ***REMOVED***);
            assert.deepEqual([
              { yep: [], arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: []***REMOVED***
            ], o.arr);

            mpath.set('arr.$.yep', [15], o);
            assert.deepEqual([
              { yep: [15], arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: [15]***REMOVED***
            ], o.arr);

            done();
          ***REMOVED***)
        ***REMOVED***)
      ***REMOVED***)

      describe('array.index.path', function(){
        it('works', function(done){
          mpath.set('arr.1.yep', 0, o, function (v) {
            return 0 === v ? 'zero' : v;
          ***REMOVED***);
          assert.deepEqual([
            { yep: [15] , arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
          , { yep: 'zero' ***REMOVED***
          ], o.arr);

          mpath.set('arr.1.yep', 0, o);
          assert.deepEqual([
            { yep: [15] , arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
      ***REMOVED***)

      describe('array.index.array.path', function(){
        it('with single value', function(done){
          mpath.set('arr.0.arr.e', 35, o, function (v) {
            return 35 === v ? 3 : v;
          ***REMOVED***);
          assert.deepEqual([
            { yep: [15], arr: [{ a: { b: 47 ***REMOVED***, e: 3***REMOVED***, { a: { c: 48 ***REMOVED***, e: 3***REMOVED***, { d: 'yep', e: 3 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          mpath.set('arr.0.arr.e', 35, o);
          assert.deepEqual([
            { yep: [15], arr: [{ a: { b: 47 ***REMOVED***, e: 35***REMOVED***, { a: { c: 48 ***REMOVED***, e: 35***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
        it('with array', function(done){
          mpath.set('arr.0.arr.e', ['a','b'], o, function (v) {
            return 'a' === v ? 'x' : v;
          ***REMOVED***);
          assert.deepEqual([
            { yep: [15], arr: [{ a: { b: 47 ***REMOVED***, e: 'x'***REMOVED***, { a: { c: 48 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          mpath.set('arr.0.arr.e', ['a','b'], o);
          assert.deepEqual([
            { yep: [15], arr: [{ a: { b: 47 ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
      ***REMOVED***)

      describe('array.index.array.path.path', function(){
        it('with single value', function(done){
          mpath.set('arr.0.arr.a.b', 36, o, function (v) {
            return 36 === v ? 3 : v;
          ***REMOVED***);
          assert.deepEqual([
            { yep: [15], arr: [{ a: { b: 3 ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48, b: 3 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          mpath.set('arr.0.arr.a.b', 36, o);
          assert.deepEqual([
            { yep: [15], arr: [{ a: { b: 36 ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48, b: 36 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
        it('with array', function(done){
          mpath.set('arr.0.arr.a.b', [1,2,3,4], o, function (v) {
            return 2 === v ? 'two' : v;
          ***REMOVED***);
          assert.deepEqual([
            { yep: [15], arr: [{ a: { b: 1 ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48, b: 'two' ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          mpath.set('arr.0.arr.a.b', [1,2,3,4], o);
          assert.deepEqual([
            { yep: [15], arr: [{ a: { b: 1 ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48, b: 2 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
      ***REMOVED***)

      describe('array.index.array.$.path.path', function(){
        it('with single value', function(done){
          mpath.set('arr.0.arr.$.a.b', '$', o, function (v) {
            return '$' === v ? 'dolla billz' : v;
          ***REMOVED***);
          assert.deepEqual([
            { yep: [15], arr: [{ a: { b: 'dolla billz' ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48, b: 'dolla billz' ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          mpath.set('arr.0.arr.$.a.b', '$', o);
          assert.deepEqual([
            { yep: [15], arr: [{ a: { b: '$' ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48, b: '$' ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
        it('with array', function(done){
          mpath.set('arr.0.arr.$.a.b', [1], o, function (v) {
            return Array.isArray(v) ? {***REMOVED*** : v;
          ***REMOVED***);
          assert.deepEqual([
            { yep: [15], arr: [{ a: { b: {***REMOVED*** ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48, b: {***REMOVED*** ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          mpath.set('arr.0.arr.$.a.b', [1], o);
          assert.deepEqual([
            { yep: [15], arr: [{ a: { b: [1] ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
      ***REMOVED***)

      describe('array.array.index.path', function(){
        it('with single value', function(done){
          mpath.set('arr.arr.0.a', 'single', o, function (v) {
            return 'single' === v ? 'double' : v;
          ***REMOVED***);
          assert.deepEqual([
            { yep: [15], arr: [{ a: 'double', e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          mpath.set('arr.arr.0.a', 'single', o);
          assert.deepEqual([
            { yep: [15], arr: [{ a: 'single', e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
        it('with array', function(done){
          mpath.set('arr.arr.0.a', [4,8,15,16,23,42], o, function (v) {
            return 4 === v ? 3 : v;
          ***REMOVED***);
          assert.deepEqual([
            { yep: [15], arr: [{ a: 3, e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: false ***REMOVED***
          ], o.arr);

          mpath.set('arr.arr.0.a', [4,8,15,16,23,42], o);
          assert.deepEqual([
            { yep: [15], arr: [{ a: 4, e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: false ***REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
      ***REMOVED***)

      describe('array.array.$.index.path', function(){
        it('with single value', function(done){
          mpath.set('arr.arr.$.0.a', 'singles', o, function (v) {
            return 0;
          ***REMOVED***);
          assert.deepEqual([
            { yep: [15], arr: [{ a: 0, e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          mpath.set('arr.arr.$.0.a', 'singles', o);
          assert.deepEqual([
            { yep: [15], arr: [{ a: 'singles', e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          mpath.set('$.arr.arr.0.a', 'single', o);
          assert.deepEqual([
            { yep: [15], arr: [{ a: 'single', e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0 ***REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
        it('with array', function(done){
          mpath.set('arr.arr.$.0.a', [4,8,15,16,23,42], o, function (v) {
            return 'nope'
          ***REMOVED***);
          assert.deepEqual([
            { yep: [15], arr: [{ a: 'nope', e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0***REMOVED***
          ], o.arr);

          mpath.set('arr.arr.$.0.a', [4,8,15,16,23,42], o);
          assert.deepEqual([
            { yep: [15], arr: [{ a: [4,8,15,16,23,42], e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0***REMOVED***
          ], o.arr);

          mpath.set('arr.$.arr.0.a', [4,8,15,16,23,42,108], o);
          assert.deepEqual([
            { yep: [15], arr: [{ a: [4,8,15,16,23,42,108], e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0***REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
      ***REMOVED***)

      describe('array.array.path.index', function(){
        it('with single value', function(done){
          mpath.set('arr.arr.a.7', 47, o, function (v) {
            return 1
          ***REMOVED***);
          assert.deepEqual([
            { yep: [15], arr: [{ a: [4,8,15,16,23,42,108,1], e: 'a'***REMOVED***, { a: { c: 48, b: [1], '7': 1 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0***REMOVED***
          ], o.arr);

          mpath.set('arr.arr.a.7', 47, o);
          assert.deepEqual([
            { yep: [15], arr: [{ a: [4,8,15,16,23,42,108,47], e: 'a'***REMOVED***, { a: { c: 48, b: [1], '7': 47 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0***REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
        it('with array', function(done){
          o.arr[1].arr = [{ a: [] ***REMOVED***, { a: [] ***REMOVED***, { a: null ***REMOVED***];
          mpath.set('arr.arr.a.7', [[null,46], [undefined, 'woot']], o);

          var a1 = [];
          var a2 = [];
          a1[7] = undefined;
          a2[7] = 'woot';

          assert.deepEqual([
            { yep: [15], arr: [{ a: [4,8,15,16,23,42,108,null], e: 'a'***REMOVED***, { a: { c: 48, b: [1], '7': 46 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED***
          , { yep: 0, arr: [{a:a1***REMOVED***,{a:a2***REMOVED***,{a:null***REMOVED***] ***REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
      ***REMOVED***)

      describe('handles array.array.path', function(){
        it('with single', function(done){
          o.arr[1].arr = [{***REMOVED***,{***REMOVED***];
          assert.deepEqual([{***REMOVED***,{***REMOVED***], o.arr[1].arr);
          o.arr.push({ arr: 'something else' ***REMOVED***);
          o.arr.push({ arr: ['something else'] ***REMOVED***);
          o.arr.push({ arr: [[]] ***REMOVED***);
          o.arr.push({ arr: [5] ***REMOVED***);

          var weird = [];
          weird.e = 'xmas';

          // test
          mpath.set('arr.arr.e', 47, o, function (v) {
            return 'xmas'
          ***REMOVED***);
          assert.deepEqual([
            { yep: [15], arr: [
                  { a: [4,8,15,16,23,42,108,null], e: 'xmas'***REMOVED***
                , { a: { c: 48, b: [1], '7': 46 ***REMOVED***, e: 'xmas'***REMOVED***
                , { d: 'yep', e: 'xmas' ***REMOVED***
              ]
            ***REMOVED***
          , { yep: 0, arr: [{e: 'xmas'***REMOVED***, {e:'xmas'***REMOVED***] ***REMOVED***
          , { arr: 'something else' ***REMOVED***
          , { arr: ['something else'] ***REMOVED***
          , { arr: [weird] ***REMOVED***
          , { arr: [5] ***REMOVED***
          ]
          , o.arr);

          weird.e = 47;

          mpath.set('arr.arr.e', 47, o);
          assert.deepEqual([
            { yep: [15], arr: [
                  { a: [4,8,15,16,23,42,108,null], e: 47***REMOVED***
                , { a: { c: 48, b: [1], '7': 46 ***REMOVED***, e: 47***REMOVED***
                , { d: 'yep', e: 47 ***REMOVED***
              ]
            ***REMOVED***
          , { yep: 0, arr: [{e: 47***REMOVED***, {e:47***REMOVED***] ***REMOVED***
          , { arr: 'something else' ***REMOVED***
          , { arr: ['something else'] ***REMOVED***
          , { arr: [weird] ***REMOVED***
          , { arr: [5] ***REMOVED***
          ]
          , o.arr);

          done();
        ***REMOVED***)
        it('with arrays', function(done){
          mpath.set('arr.arr.e', [[1,2,3],[4,5],null,[],[6], [7,8,9]], o, function (v) {
            return 10;
          ***REMOVED***);

          var weird = [];
          weird.e = 10;

          assert.deepEqual([
            { yep: [15], arr: [
                  { a: [4,8,15,16,23,42,108,null], e: 10***REMOVED***
                , { a: { c: 48, b: [1], '7': 46 ***REMOVED***, e: 10***REMOVED***
                , { d: 'yep', e: 10 ***REMOVED***
              ]
            ***REMOVED***
          , { yep: 0, arr: [{e: 10***REMOVED***, {e:10***REMOVED***] ***REMOVED***
          , { arr: 'something else' ***REMOVED***
          , { arr: ['something else'] ***REMOVED***
          , { arr: [weird] ***REMOVED***
          , { arr: [5] ***REMOVED***
          ]
          , o.arr);

          mpath.set('arr.arr.e', [[1,2,3],[4,5],null,[],[6], [7,8,9]], o);

          weird.e = 6;

          assert.deepEqual([
            { yep: [15], arr: [
                  { a: [4,8,15,16,23,42,108,null], e: 1***REMOVED***
                , { a: { c: 48, b: [1], '7': 46 ***REMOVED***, e: 2***REMOVED***
                , { d: 'yep', e: 3 ***REMOVED***
              ]
            ***REMOVED***
          , { yep: 0, arr: [{e: 4***REMOVED***, {e:5***REMOVED***] ***REMOVED***
          , { arr: 'something else' ***REMOVED***
          , { arr: ['something else'] ***REMOVED***
          , { arr: [weird] ***REMOVED***
          , { arr: [5] ***REMOVED***
          ]
          , o.arr);

          done();
        ***REMOVED***)
      ***REMOVED***)
    ***REMOVED***)

    describe('with `special`', function(){
      var o = doc();

      it('works', function(done){
        mpath.set('name', 'chan', o, special, function (v) {
          return 'hi';
        ***REMOVED***);
        assert.deepEqual('hi', o.name);

        mpath.set('name', 'changer', o, special);
        assert.deepEqual('changer', o.name);

        mpath.set('first.second.third', [1,{name:'y'***REMOVED***,9], o, special);
        assert.deepEqual([1,{name:'y'***REMOVED***,9], o.first.second.third);

        mpath.set('first.second.third.1.name', 'z', o, special)
        assert.deepEqual([1,{name:'z'***REMOVED***,9], o.first.second.third);

        mpath.set('comments.1.name', 'ttwwoo', o, special);
        assert.deepEqual({ name: 'two', _doc: { name: 'ttwwoo' ***REMOVED******REMOVED***, o.comments[1]);

        mpath.set('comments.2.comments.1.comments.0.expander', 'adder', o, special, function (v) {
          return 'super'
        ***REMOVED***);
        assert.deepEqual(
            { val: 2, expander: 'super'***REMOVED***
          , o.comments[2]._doc.comments[1]._doc.comments[0]);

        mpath.set('comments.2.comments.1.comments.0.expander', 'adder', o, special);
        assert.deepEqual(
            { val: 2, expander: 'adder'***REMOVED***
          , o.comments[2]._doc.comments[1]._doc.comments[0]);

        mpath.set('comments.2.comments.1.comments.2', 'set', o, special);
        assert.equal(3, o.comments[2]._doc.comments[1]._doc.comments.length);
        assert.deepEqual(
            { val: 2, expander: 'adder'***REMOVED***
          , o.comments[2]._doc.comments[1]._doc.comments[0]);
        assert.deepEqual(
            undefined
          , o.comments[2]._doc.comments[1]._doc.comments[1]);
        assert.deepEqual(
            'set'
          , o.comments[2]._doc.comments[1]._doc.comments[2]);
        done();
      ***REMOVED***)

      describe('array.path', function(){
        describe('with single non-array value', function(){
          it('works', function(done){
            o.arr[1]._doc = { special: true ***REMOVED***

            mpath.set('arr.yep', false, o, special, function (v) {
              return 'yes';
            ***REMOVED***);
            assert.deepEqual([
              { yep: 'yes', arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 'yes'***REMOVED******REMOVED***
            ], o.arr);

            mpath.set('arr.yep', false, o, special);
            assert.deepEqual([
              { yep: false, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: true, _doc: { special: true, yep: false ***REMOVED******REMOVED***
            ], o.arr);

            done();
          ***REMOVED***)
        ***REMOVED***)
        describe('with array of values', function(){
          it('that are equal in length', function(done){
            mpath.set('arr.yep', ['one',2], o, special, function (v) {
              return 2 === v ? 20 : v;
            ***REMOVED***);
            assert.deepEqual([
              { yep: 'one', arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 20***REMOVED******REMOVED***
            ], o.arr);

            mpath.set('arr.yep', ['one',2], o, special);
            assert.deepEqual([
              { yep: 'one', arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 2***REMOVED******REMOVED***
            ], o.arr);

            done();
          ***REMOVED***)

          it('that is less than length', function(done){
            mpath.set('arr.yep', [47], o, special, function (v) {
              return 80;
            ***REMOVED***);
            assert.deepEqual([
              { yep: 80, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 2***REMOVED******REMOVED***
            ], o.arr);

            mpath.set('arr.yep', [47], o, special);
            assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 2***REMOVED******REMOVED***
            ], o.arr);

            // add _doc to first element
            o.arr[0]._doc = { yep: 46, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED***

            mpath.set('arr.yep', [20], o, special);
            assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***], _doc: { yep: 20, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 2***REMOVED******REMOVED***
            ], o.arr);

            done();
          ***REMOVED***)

          it('that is greater than length', function(done){
            mpath.set('arr.yep', [5,6,7], o, special, function () {
              return 'x';
            ***REMOVED***);
            assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***], _doc: { yep: 'x', arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 'x'***REMOVED******REMOVED***
            ], o.arr);

            mpath.set('arr.yep', [5,6,7], o, special);
            assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***], _doc: { yep: 5, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 6***REMOVED******REMOVED***
            ], o.arr);

            done();
          ***REMOVED***)
        ***REMOVED***)
      ***REMOVED***)

      describe('array.$.path', function(){
        describe('with single non-array value', function(){
          it('copies the value to each item in array', function(done){
            mpath.set('arr.$.yep', {xtra: 'double good'***REMOVED***, o, special, function (v) {
              return 9;
            ***REMOVED***);
            assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: 9, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 9***REMOVED******REMOVED***
            ], o.arr);

            mpath.set('arr.$.yep', {xtra: 'double good'***REMOVED***, o, special);
            assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: {xtra:'double good'***REMOVED***, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: {xtra:'double good'***REMOVED******REMOVED******REMOVED***
            ], o.arr);

            done();
          ***REMOVED***)
        ***REMOVED***)
        describe('with array of values', function(){
          it('copies the value to each item in array', function(done){
            mpath.set('arr.$.yep', [15], o, special, function (v) {
              return 'array'
            ***REMOVED***);
            assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: 'array', arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 'array'***REMOVED******REMOVED***
            ], o.arr);

            mpath.set('arr.$.yep', [15], o, special);
            assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: [15]***REMOVED******REMOVED***
            ], o.arr);

            done();
          ***REMOVED***)
        ***REMOVED***)
      ***REMOVED***)

      describe('array.index.path', function(){
        it('works', function(done){
          mpath.set('arr.1.yep', 0, o, special, function (v) {
            return 1;
          ***REMOVED***);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 1***REMOVED******REMOVED***
          ], o.arr);

          mpath.set('arr.1.yep', 0, o, special);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
      ***REMOVED***)

      describe('array.index.array.path', function(){
        it('with single value', function(done){
          mpath.set('arr.0.arr.e', 35, o, special, function (v) {
            return 30
          ***REMOVED***);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: { b: 47 ***REMOVED***, e: 30***REMOVED***, { a: { c: 48 ***REMOVED***, e: 30***REMOVED***, { d: 'yep', e: 30 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          mpath.set('arr.0.arr.e', 35, o, special);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: { b: 47 ***REMOVED***, e: 35***REMOVED***, { a: { c: 48 ***REMOVED***, e: 35***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
        it('with array', function(done){
          mpath.set('arr.0.arr.e', ['a','b'], o, special, function (v) {
            return 'a' === v ? 'A' : v;
          ***REMOVED***);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: { b: 47 ***REMOVED***, e: 'A'***REMOVED***, { a: { c: 48 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          mpath.set('arr.0.arr.e', ['a','b'], o, special);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: { b: 47 ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
      ***REMOVED***)

      describe('array.index.array.path.path', function(){
        it('with single value', function(done){
          mpath.set('arr.0.arr.a.b', 36, o, special, function (v) {
            return 20
          ***REMOVED***);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: { b: 20 ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48, b: 20 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          mpath.set('arr.0.arr.a.b', 36, o, special);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: { b: 36 ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48, b: 36 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
        it('with array', function(done){
          mpath.set('arr.0.arr.a.b', [1,2,3,4], o, special, function (v) {
            return v*2;
          ***REMOVED***);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: { b: 2 ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48, b: 4 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          mpath.set('arr.0.arr.a.b', [1,2,3,4], o, special);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: { b: 1 ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48, b: 2 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
      ***REMOVED***)

      describe('array.index.array.$.path.path', function(){
        it('with single value', function(done){
          mpath.set('arr.0.arr.$.a.b', '$', o, special, function (v) {
            return 'dollaz'
          ***REMOVED***);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: { b: 'dollaz' ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48, b: 'dollaz' ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          mpath.set('arr.0.arr.$.a.b', '$', o, special);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: { b: '$' ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48, b: '$' ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
        it('with array', function(done){
          mpath.set('arr.0.arr.$.a.b', [1], o, special, function (v) {
            return {***REMOVED***;
          ***REMOVED***);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: { b: {***REMOVED*** ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48, b: {***REMOVED*** ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          mpath.set('arr.0.arr.$.a.b', [1], o, special);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: { b: [1] ***REMOVED***, e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
      ***REMOVED***)

      describe('array.array.index.path', function(){
        it('with single value', function(done){
          mpath.set('arr.arr.0.a', 'single', o, special, function (v) {
            return 88;
          ***REMOVED***);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: 88, e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          mpath.set('arr.arr.0.a', 'single', o, special);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: 'single', e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
        it('with array', function(done){
          mpath.set('arr.arr.0.a', [4,8,15,16,23,42], o, special, function (v) {
            return v*2;
          ***REMOVED***);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: 8, e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          mpath.set('arr.arr.0.a', [4,8,15,16,23,42], o, special);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: 4, e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
      ***REMOVED***)

      describe('array.array.$.index.path', function(){
        it('with single value', function(done){
          mpath.set('arr.arr.$.0.a', 'singles', o, special, function (v) {
            return v.toUpperCase();
          ***REMOVED***);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: 'SINGLES', e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          mpath.set('arr.arr.$.0.a', 'singles', o, special);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: 'singles', e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          mpath.set('$.arr.arr.0.a', 'single', o, special);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: 'single', e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
        it('with array', function(done){
          mpath.set('arr.arr.$.0.a', [4,8,15,16,23,42], o, special, function (v) {
            return Array
          ***REMOVED***);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: Array, e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          mpath.set('arr.arr.$.0.a', [4,8,15,16,23,42], o, special);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: [4,8,15,16,23,42], e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          mpath.set('arr.$.arr.0.a', [4,8,15,16,23,42,108], o, special);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: [4,8,15,16,23,42,108], e: 'a'***REMOVED***, { a: { c: 48, b: [1] ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
      ***REMOVED***)

      describe('array.array.path.index', function(){
        it('with single value', function(done){
          mpath.set('arr.arr.a.7', 47, o, special, function (v) {
            return Object;
          ***REMOVED***);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: [4,8,15,16,23,42,108,Object], e: 'a'***REMOVED***, { a: { c: 48, b: [1], '7': Object ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          mpath.set('arr.arr.a.7', 47, o, special);
          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: [4,8,15,16,23,42,108,47], e: 'a'***REMOVED***, { a: { c: 48, b: [1], '7': 47 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
        it('with array', function(done){
          o.arr[1]._doc.arr = [{ a: [] ***REMOVED***, { a: [] ***REMOVED***, { a: null ***REMOVED***];
          mpath.set('arr.arr.a.7', [[null,46], [undefined, 'woot']], o, special, function (v) {
            return undefined === v ? 'nope' : v;
          ***REMOVED***);

          var a1 = [];
          var a2 = [];
          a1[7] = 'nope';
          a2[7] = 'woot';

          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: [4,8,15,16,23,42,108,null], e: 'a'***REMOVED***, { a: { c: 48, b: [1], '7': 46 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { arr: [{a:a1***REMOVED***,{a:a2***REMOVED***,{a:null***REMOVED***], special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          mpath.set('arr.arr.a.7', [[null,46], [undefined, 'woot']], o, special);

          a1[7] = undefined;

          assert.deepEqual([
              { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
                , _doc: { yep: [15], arr: [{ a: [4,8,15,16,23,42,108,null], e: 'a'***REMOVED***, { a: { c: 48, b: [1], '7': 46 ***REMOVED***, e: 'b'***REMOVED***, { d: 'yep', e: 35 ***REMOVED***] ***REMOVED*** ***REMOVED***
            , { yep: true, _doc: { arr: [{a:a1***REMOVED***,{a:a2***REMOVED***,{a:null***REMOVED***], special: true, yep: 0***REMOVED******REMOVED***
          ], o.arr);

          done();
        ***REMOVED***)
      ***REMOVED***)

      describe('handles array.array.path', function(){
        it('with single', function(done){
          o.arr[1]._doc.arr = [{***REMOVED***,{***REMOVED***];
          assert.deepEqual([{***REMOVED***,{***REMOVED***], o.arr[1]._doc.arr);
          o.arr.push({ _doc: { arr: 'something else' ***REMOVED******REMOVED***);
          o.arr.push({ _doc: { arr: ['something else'] ***REMOVED******REMOVED***);
          o.arr.push({ _doc: { arr: [[]] ***REMOVED******REMOVED***);
          o.arr.push({ _doc: { arr: [5] ***REMOVED******REMOVED***);

          // test
          mpath.set('arr.arr.e', 47, o, special);

          var weird = [];
          weird.e = 47;

          assert.deepEqual([
            { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
              , _doc: {
                  yep: [15]
                , arr: [
                    { a: [4,8,15,16,23,42,108,null], e: 47***REMOVED***
                  , { a: { c: 48, b: [1], '7': 46 ***REMOVED***, e: 47***REMOVED***
                  , { d: 'yep', e: 47 ***REMOVED***
                  ]
              ***REMOVED***
            ***REMOVED***
          , { yep: true
              , _doc: {
                  arr: [
                     {e:47***REMOVED***
                   , {e:47***REMOVED***
                  ]
                , special: true
                , yep: 0
              ***REMOVED***
            ***REMOVED***
          , { _doc: { arr: 'something else' ***REMOVED******REMOVED***
          , { _doc: { arr: ['something else'] ***REMOVED******REMOVED***
          , { _doc: { arr: [weird] ***REMOVED******REMOVED***
          , { _doc: { arr: [5] ***REMOVED******REMOVED***
          ]
          , o.arr);

          done();
        ***REMOVED***)
        it('with arrays', function(done){
          mpath.set('arr.arr.e', [[1,2,3],[4,5],null,[],[6], [7,8,9]], o, special);

          var weird = [];
          weird.e = 6;

          assert.deepEqual([
            { yep: 47, arr: [{ a: { b: 47 ***REMOVED******REMOVED***, { a: { c: 48 ***REMOVED******REMOVED***, { d: 'yep' ***REMOVED***]
              , _doc: {
                  yep: [15]
                , arr: [
                    { a: [4,8,15,16,23,42,108,null], e: 1***REMOVED***
                  , { a: { c: 48, b: [1], '7': 46 ***REMOVED***, e: 2***REMOVED***
                  , { d: 'yep', e: 3 ***REMOVED***
                  ]
              ***REMOVED***
            ***REMOVED***
          , { yep: true
              , _doc: {
                  arr: [
                     {e:4***REMOVED***
                   , {e:5***REMOVED***
                  ]
                , special: true
                , yep: 0
              ***REMOVED***
            ***REMOVED***
          , { _doc: { arr: 'something else' ***REMOVED******REMOVED***
          , { _doc: { arr: ['something else'] ***REMOVED******REMOVED***
          , { _doc: { arr: [weird] ***REMOVED******REMOVED***
          , { _doc: { arr: [5] ***REMOVED******REMOVED***
          ]
          , o.arr);

          done();
        ***REMOVED***)
      ***REMOVED***)

      describe('that is a function', function(){
        describe('without map', function(){
          it('works on array value', function(done){
            var o = { hello: { world: [{ how: 'are' ***REMOVED***, { you: '?' ***REMOVED***] ***REMOVED******REMOVED***;
            var special = function (obj, key, val) {
              if (val) {
                obj[key] = val;
              ***REMOVED***
                return 'thing' == key
                  ? obj.world
                  : obj[key]
              ***REMOVED***
            ***REMOVED***
            mpath.set('hello.thing.how', 'arrrr', o, special);
            assert.deepEqual(o, { hello: { world: [{ how: 'arrrr' ***REMOVED***, { you: '?', how: 'arrrr' ***REMOVED***] ***REMOVED******REMOVED***);
            done();
          ***REMOVED***)
          it('works on non-array value', function(done){
            var o = { hello: { world: { how: 'are you' ***REMOVED******REMOVED******REMOVED***;
            var special = function (obj, key, val) {
              if (val) {
                obj[key] = val;
              ***REMOVED***
                return 'thing' == key
                  ? obj.world
                  : obj[key]
              ***REMOVED***
            ***REMOVED***
            mpath.set('hello.thing.how', 'RU', o, special);
            assert.deepEqual(o, { hello: { world: { how: 'RU' ***REMOVED******REMOVED******REMOVED***);
            done();
          ***REMOVED***)
        ***REMOVED***)
        it('works with map', function(done){
          var o = { hello: { world: [{ how: 'are' ***REMOVED***, { you: '?' ***REMOVED***] ***REMOVED******REMOVED***;
          var special = function (obj, key, val) {
            if (val) {
              obj[key] = val;
            ***REMOVED***
              return 'thing' == key
                ? obj.world
                : obj[key]
            ***REMOVED***
          ***REMOVED***
          var map = function (val) {
            return 'convert' == val
              ? 'ºº'
              : val
          ***REMOVED***
          mpath.set('hello.thing.how', 'convert', o, special, map);
          assert.deepEqual(o, { hello: { world: [{ how: 'ºº' ***REMOVED***, { you: '?', how: 'ºº' ***REMOVED***] ***REMOVED******REMOVED***);
          done();
        ***REMOVED***)
      ***REMOVED***)

    ***REMOVED***)

    describe('get/set integration', function(){
      var o = doc();

      it('works', function(done){
        var vals = mpath.get('array.o.array.x.b', o);

        vals[0][0][2] = 10;
        vals[1][0][1] = 0;
        vals[1][1] = 'Rambaldi';
        vals[1][2] = [12,14];
        vals[2] = [{changed:true***REMOVED***, [null, ['changed','to','array']]];

        mpath.set('array.o.array.x.b', vals, o);

        var t = [
            { o: { array: [{x: {b: [4,6,10]***REMOVED******REMOVED***, { y: 10***REMOVED*** ] ***REMOVED******REMOVED***
          , { o: { array: [{x: {b: [1,0,3]***REMOVED******REMOVED***, { x: {b:'Rambaldi',z: 10 ***REMOVED******REMOVED***, { x: {b: [12,14]***REMOVED******REMOVED***] ***REMOVED******REMOVED***
          , { o: { array: [{x: {b: {changed:true***REMOVED******REMOVED******REMOVED***, { x: { b: [null, ['changed','to','array']]***REMOVED******REMOVED***]***REMOVED******REMOVED***
          , { o: { array: [{x: null ***REMOVED***] ***REMOVED******REMOVED***
          , { o: { array: [{y: 3 ***REMOVED***] ***REMOVED******REMOVED***
          , { o: { array: [3, 0, null] ***REMOVED******REMOVED***
          , { o: { name: 'ha' ***REMOVED******REMOVED***
        ];
        assert.deepEqual(t, o.array);
        done();
      ***REMOVED***)

      it('array.prop', function(done){
        mpath.set('comments.name', ['this', 'was', 'changed'], o);

        assert.deepEqual([
            { name: 'this' ***REMOVED***
          , { name: 'was', _doc: { name: '2' ***REMOVED******REMOVED***
          , { name: 'changed'
              , comments: [{***REMOVED***,{ comments: [{val: 'twoo'***REMOVED***]***REMOVED***]
              , _doc: { name: '3', comments: [{***REMOVED***,{ _doc: { comments: [{ val: 2 ***REMOVED***] ***REMOVED******REMOVED***]  ***REMOVED******REMOVED***
        ], o.comments);

        mpath.set('comments.name', ['also', 'changed', 'this'], o, special);

        assert.deepEqual([
            { name: 'also' ***REMOVED***
          , { name: 'was', _doc: { name: 'changed' ***REMOVED******REMOVED***
          , { name: 'changed'
              , comments: [{***REMOVED***,{ comments: [{val: 'twoo'***REMOVED***]***REMOVED***]
              , _doc: { name: 'this', comments: [{***REMOVED***,{ _doc: { comments: [{ val: 2 ***REMOVED***] ***REMOVED******REMOVED***]  ***REMOVED******REMOVED***
        ], o.comments);

        done();
      ***REMOVED***)

    ***REMOVED***)

    describe('multiple $ use', function(){
      var o = doc();
      it('is ok', function(done){
        assert.doesNotThrow(function () {
          mpath.set('arr.$.arr.$.a', 35, o);
        ***REMOVED***);
        done();
      ***REMOVED***)
    ***REMOVED***)

    it('has', function(done) {
      assert.ok(mpath.has('a', { a: 1 ***REMOVED***));
      assert.ok(mpath.has('a', { a: undefined ***REMOVED***));
      assert.ok(!mpath.has('a', {***REMOVED***));
      assert.ok(!mpath.has('a', null));

      assert.ok(mpath.has('a.b', { a: { b: 1 ***REMOVED*** ***REMOVED***));
      assert.ok(mpath.has('a.b', { a: { b: undefined ***REMOVED*** ***REMOVED***));
      assert.ok(!mpath.has('a.b', { a: 1 ***REMOVED***));
      assert.ok(!mpath.has('a.b', { a: null ***REMOVED***));

      done();
    ***REMOVED***);

    it('underneath a map', function(done) {
      if (!global.Map) {
        done();
        return;
      ***REMOVED***
      assert.equal(mpath.get('a.b', { a: new Map([['b', 1]]) ***REMOVED***), 1);

      var m = new Map([['b', 1]]);
      var obj = { a: m ***REMOVED***;
      mpath.set('a.c', 2, obj);
      assert.equal(m.get('c'), 2);

      done();
    ***REMOVED***);

    it('unset', function(done) {
      var o = { a: 1 ***REMOVED***;
      mpath.unset('a', o);
      assert.deepEqual(o, {***REMOVED***);

      o = { a: { b: 1 ***REMOVED*** ***REMOVED***;
      mpath.unset('a.b', o);
      assert.deepEqual(o, { a: {***REMOVED*** ***REMOVED***);

      o = { a: null ***REMOVED***;
      mpath.unset('a.b', o);
      assert.deepEqual(o, { a: null ***REMOVED***);

      done();
    ***REMOVED***);

    it('unset with __proto__', function(done) {
      // Should refuse to set __proto__
      function Clazz() {***REMOVED***
      Clazz.prototype.foobar = true;

      mpath.unset('__proto__.foobar', new Clazz());
      assert.ok(Clazz.prototype.foobar);

      mpath.unset('constructor.prototype.foobar', new Clazz());
      assert.ok(Clazz.prototype.foobar);

      done();
    ***REMOVED***);

    it('ignores setting a nested path that doesnt exist', function(done){
      var o = doc();
      assert.doesNotThrow(function(){
        mpath.set('thing.that.is.new', 10, o);
      ***REMOVED***)
      done();
    ***REMOVED***);
  ***REMOVED***);
***REMOVED***);
