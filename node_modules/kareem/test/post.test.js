'use strict';

const assert = require('assert');
const Kareem = require('../');

describe('execPost', function() {
  var hooks;

  beforeEach(function() {
    hooks = new Kareem();
  ***REMOVED***);

  it('handles errors', function(done) {
    hooks.post('cook', function(eggs, callback) {
      callback('error!');
    ***REMOVED***);

    hooks.execPost('cook', null, [4], function(error, eggs) {
      assert.equal('error!', error);
      assert.ok(!eggs);
      done();
    ***REMOVED***);
  ***REMOVED***);

  it('unshift', function() {
    var f1 = function() {***REMOVED***;
    var f2 = function() {***REMOVED***;
    hooks.post('cook', f1);
    hooks.post('cook', f2, true);
    assert.strictEqual(hooks._posts.get('cook')[0].fn, f2);
    assert.strictEqual(hooks._posts.get('cook')[1].fn, f1);
  ***REMOVED***);

  it('arbitrary options', function() {
    const f1 = function() {***REMOVED***;
    const f2 = function() {***REMOVED***;
    hooks.post('cook', { foo: 'bar' ***REMOVED***, f1);
    hooks.post('cook', { bar: 'baz' ***REMOVED***, f2, true);
    assert.equal(hooks._posts.get('cook')[1].foo, 'bar');
    assert.equal(hooks._posts.get('cook')[0].bar, 'baz');
  ***REMOVED***);

  it('multiple posts', function(done) {
    hooks.post('cook', function(eggs, callback) {
      setTimeout(
        function() {
          callback();
        ***REMOVED***,
        5);
    ***REMOVED***);

    hooks.post('cook', function(eggs, callback) {
      setTimeout(
        function() {
          callback();
        ***REMOVED***,
        5);
    ***REMOVED***);

    hooks.execPost('cook', null, [4], function(error, eggs) {
      assert.ifError(error);
      assert.equal(4, eggs);
      done();
    ***REMOVED***);
  ***REMOVED***);

  it('error posts', function(done) {
    var called = {***REMOVED***;
    hooks.post('cook', function(eggs, callback) {
      called.first = true;
      callback();
    ***REMOVED***);

    hooks.post('cook', function(eggs, callback) {
      called.second = true;
      callback(new Error('fail'));
    ***REMOVED***);

    hooks.post('cook', function(eggs, callback) {
      assert.ok(false);
    ***REMOVED***);

    hooks.post('cook', function(error, eggs, callback) {
      called.fourth = true;
      assert.equal(error.message, 'fail');
      callback(new Error('fourth'));
    ***REMOVED***);

    hooks.post('cook', function(error, eggs, callback) {
      called.fifth = true;
      assert.equal(error.message, 'fourth');
      callback(new Error('fifth'));
    ***REMOVED***);

    hooks.execPost('cook', null, [4], function(error, eggs) {
      assert.ok(error);
      assert.equal(error.message, 'fifth');
      assert.deepEqual(called, {
        first: true,
        second: true,
        fourth: true,
        fifth: true
      ***REMOVED***);
      done();
    ***REMOVED***);
  ***REMOVED***);

  it('error posts with initial error', function(done) {
    var called = {***REMOVED***;

    hooks.post('cook', function(eggs, callback) {
      assert.ok(false);
    ***REMOVED***);

    hooks.post('cook', function(error, eggs, callback) {
      called.second = true;
      assert.equal(error.message, 'fail');
      callback(new Error('second'));
    ***REMOVED***);

    hooks.post('cook', function(error, eggs, callback) {
      called.third = true;
      assert.equal(error.message, 'second');
      callback(new Error('third'));
    ***REMOVED***);

    hooks.post('cook', function(error, eggs, callback) {
      called.fourth = true;
      assert.equal(error.message, 'third');
      callback();
    ***REMOVED***);

    var options = { error: new Error('fail') ***REMOVED***;
    hooks.execPost('cook', null, [4], options, function(error, eggs) {
      assert.ok(error);
      assert.equal(error.message, 'third');
      assert.deepEqual(called, {
        second: true,
        third: true,
        fourth: true
      ***REMOVED***);
      done();
    ***REMOVED***);
  ***REMOVED***);

  it('supports returning a promise', function(done) {
    var calledPost = 0;

    hooks.post('cook', function() {
      return new Promise(resolve => {
        setTimeout(() => {
          ++calledPost;
          resolve();
        ***REMOVED***, 100);
      ***REMOVED***);
    ***REMOVED***);

    hooks.execPost('cook', null, [], {***REMOVED***, function(error) {
      assert.ifError(error);
      assert.equal(calledPost, 1);
      done();
    ***REMOVED***);
  ***REMOVED***);
***REMOVED***);

describe('execPostSync', function() {
  var hooks;

  beforeEach(function() {
    hooks = new Kareem();
  ***REMOVED***);

  it('executes hooks synchronously', function() {
    var execed = {***REMOVED***;

    hooks.post('cook', function() {
      execed.first = true;
    ***REMOVED***);

    hooks.post('cook', function() {
      execed.second = true;
    ***REMOVED***);

    hooks.execPostSync('cook', null);
    assert.ok(execed.first);
    assert.ok(execed.second);
  ***REMOVED***);

  it('works with no hooks specified', function() {
    assert.doesNotThrow(function() {
      hooks.execPostSync('cook', null);
    ***REMOVED***);
  ***REMOVED***);
***REMOVED***);
