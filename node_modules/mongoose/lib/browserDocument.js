/*!
 * Module dependencies.
 */

'use strict';

const NodeJSDocument = require('./document');
const EventEmitter = require('events').EventEmitter;
const MongooseError = require('./error');
const Schema = require('./schema');
const ObjectId = require('./types/objectid');
const ValidationError = MongooseError.ValidationError;
const applyHooks = require('./helpers/model/applyHooks');
const utils = require('./utils');

/**
 * Document constructor.
 *
 * @param {Object***REMOVED*** obj the values to set
 * @param {Object***REMOVED*** [fields] optional object containing the fields which were selected in the query returning this document and any populated paths data
 * @param {Boolean***REMOVED*** [skipId] bool, should we auto create an ObjectId _id
 * @inherits NodeJS EventEmitter http://nodejs.org/api/events.html#events_class_events_eventemitter
 * @event `init`: Emitted on a document after it has was retrieved from the db and fully hydrated by Mongoose.
 * @event `save`: Emitted when the document is successfully saved
 * @api private
 */

function Document(obj, schema, fields, skipId, skipInit) {
  if (!(this instanceof Document)) {
    return new Document(obj, schema, fields, skipId, skipInit);
  ***REMOVED***

  if (utils.isObject(schema) && !schema.instanceOfSchema) {
    schema = new Schema(schema);
  ***REMOVED***

  // When creating EmbeddedDocument, it already has the schema and he doesn't need the _id
  schema = this.schema || schema;

  // Generate ObjectId if it is missing, but it requires a scheme
  if (!this.schema && schema.options._id) {
    obj = obj || {***REMOVED***;

    if (obj._id === undefined) {
      obj._id = new ObjectId();
    ***REMOVED***
  ***REMOVED***

  if (!schema) {
    throw new MongooseError.MissingSchemaError();
  ***REMOVED***

  this.$__setSchema(schema);

  NodeJSDocument.call(this, obj, fields, skipId, skipInit);

  applyHooks(this, schema, { decorateDoc: true ***REMOVED***);

  // apply methods
  for (const m in schema.methods) {
    this[m] = schema.methods[m];
  ***REMOVED***
  // apply statics
  for (const s in schema.statics) {
    this[s] = schema.statics[s];
  ***REMOVED***
***REMOVED***

/*!
 * Inherit from the NodeJS document
 */

Document.prototype = Object.create(NodeJSDocument.prototype);
Document.prototype.constructor = Document;

/*!
 * Browser doc exposes the event emitter API
 */

Document.$emitter = new EventEmitter();

utils.each(
  ['on', 'once', 'emit', 'listeners', 'removeListener', 'setMaxListeners',
    'removeAllListeners', 'addListener'],
  function(emitterFn) {
    Document[emitterFn] = function() {
      return Document.$emitter[emitterFn].apply(Document.$emitter, arguments);
    ***REMOVED***;
  ***REMOVED***);

/*!
 * Module exports.
 */

Document.ValidationError = ValidationError;
module.exports = exports = Document;
